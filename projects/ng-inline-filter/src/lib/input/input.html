<div class="nf nf-complex-filter" (click2)="autocomplete.focus()" (keydown)="_handleKeyDown($event)" #root>
    <div class="nf-scrollable" #scrollable>
        <div class="nf-complex-filter-filters">
            @for (filter of filterItems(); track $index) {
                <filter-node
                    [container]="scrollable"
                    [context]="context()"
                    [disabled]="disabled()"
                    [level]="0"
                    [node]="$any(filter)"
                    (nodeRemove)="_removeFilter($index, $event.byButton)"
                    (nodeChange)="_changeFilterItem($index, $event)"
                    [options]="options()" />
            }

            @if (context().fields.length > 0) {
                <filter-dropdown
                    [asButton]="true"
                    [items]="context().fields"
                    [showSearch]="true"
                    [showDescription]="true"
                    [typeaheadLabel]="'NONE'"
                    [value]="null"
                    (valueChange)="_addFilter($event || '', false)"
                    [options]="options()" />
            }
        </div>

        <filter-autocomplete
            #autocomplete
            [container]="scrollable"
            (delete)="_focusLastFilter()"
            [disabled]="disabled()"
            [fields]="context().fields"
            (fieldSelect)="_addFilter($event, true)"
            [options]="options()"
            [value]="query().text"
            (valueChange)="_changeQuery($event || '')" />
    </div>

    <div class="nf-complex-filter-buttons" (click)="$event.stopPropagation()">
        <button class="{{options().cssClasses.buttonDefault(isLogicalAnd())}} nf-code" (click)="_changeLogic();">
            {{options().texts.and}}
        </button>
        <button class="{{options().cssClasses.buttonDefault(isLogicalOr())}} nf-code" (click)="_changeLogic();">
            {{options().texts.or}}
        </button>
    </div>

    <div class="nf-complex-filter-buttons" (click)="$event.stopPropagation()">
        @if (isBookmarked() === true || isBookmarked() === false) {
            <button [class]="options().cssClasses.buttonDefault(false)" (click)="_toggleBookmark()">
                @if (isBookmarked() === true) {
                    <svg xmlns="http://www.w3.org/2000/svg" height="24px" width="24px" viewBox="0 -960 960 960">
                        <path d="m233-120 65-281L80-590l288-25 112-265 112 265 288 25-218 189 65 281-247-149-247 149Z" />
                    </svg>
                } @else {
                    <svg xmlns="http://www.w3.org/2000/svg" height="24px" width="24px" viewBox="0 -960 960 960" >
                        <path d="m354-287 126-76 126 77-33-144 111-96-146-13-58-136-58 135-146 13 111 97-33 143ZM233-120l65-281L80-590l288-25 112-265 112 265 288 25-218 189 65 281-247-149-247 149Zm247-350Z" />
                    </svg>
                }
            </button>
        }

        <button [class]="options().cssClasses.buttonDefault(false)" (click)="_toggleMenu()">
            @if (isMenuOpen()) {
                <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px">
                    <path d="M480-528 296-344l-56-56 240-240 240 240-56 56-184-184Z"/>
                </svg>
            } @else {
                <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px">
                    <path d="M480-344 240-584l56-56 184 184 184-184 56 56-240 240Z"/>
                </svg>
            }
        </button>
    </div>
</div>

<ng-template #menu
    cdkConnectedOverlay
    [cdkConnectedOverlayOrigin]="root"
    [cdkConnectedOverlayOffsetY]="1"
    [cdkConnectedOverlayOpen]="isMenuOpen()">
    <div [filterSameSize]="root">
        <filter-details
            [context]="context()"
            [disabled]="disabled()"
            [node]="query().filter"
            (nodeChange)="_changeFilter($event)"
            [sorting]="query().sorting"
            (sortingChange)="_changeSorting($event)"
            [options]="options()" />
    </div>
</ng-template>